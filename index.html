<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="css/style.css">
<script type="text/javascript" src="paperjs/dist/paper-full.js"></script>
<script type="text/paperscript" canvas="cvs">
  // console.log(1);
  function Ball(r, p, v, c) {
    this.radius = r;
    this.point = p;
    this.vector = v;
    this.charge = c;
    this.maxVec = 6;
    this.path = new Path.Circle({
      center: this.point,
      radius: this.radius,
      fillColor: {
        hue: Math.random() * 360,
        saturation: 1,
        brightness: 1
      },
      blendMode: 'screen'
    });
  }

  Ball.prototype = {
      iterate: function() {
        this.checkBorders();
        if (this.vector.length > this.maxVec)
            this.vector.length = this.maxVec;
        this.point += this.vector;
        this.path.position = this.point;
      },

      checkBorders: function() {
        var size = view.size;

        if (this.point.x < this.radius && this.vector.x < 0)
            this.vector.x *= -1;
        if (this.point.x > size.width - this.radius && this.vector.x > 0)
            this.vector.x *= -1;
        if (this.point.y < this.radius && this.vector.y < 0)
            this.vector.y *= -1;
        if (this.point.y > size.height - this.radius && this.vector.y > 0)
            this.vector.y *= -1;
      }
  };

  function Particle(r, p, m) {
    this.radius = r;
    this.point = p;
    this.momentum = m;
    this.path = new Path.Circle({
      center: this.point,
      radius: this.radius,
      fillColor: {
        hue: Math.random() * 360,
        saturation: 1,
        brightness: 1
      },
      blendMode: 'screen'
    });
  }

  function Pair(b1, b2) {
    this.b1 = b1;
    this.b2 = b2;

    // momentum
    var m = (this.b2.path.position - this.b1.path.position).normalize() * params.strength * this.b1.charge;
    this.p = new Particle(this.b1.radius / 4, this.b1.path.position, m);
  }

  Pair.prototype = {
    iterate: function () {
      // vector 1 is going from particle 1 to ball 2
      var v = this.b2.path.position - this.p.path.position;

      // update particle position
      this.p.path.position += v.normalize() * params.particleVelosity;

      // if particle reached its destinition
      if (v.length < this.b2.radius) {
        // update momentum
        // add momentum to reciver
        this.b2.vector += this.p.momentum;

        this.p.momentum = (this.b2.path.position - this.b1.path.position).normalize() * params.strength * this.b1.charge;
        // subtruct momentum form emitter
        this.b1.vector -= this.p.momentum;
        // move partice back to start
        this.p.path.position = this.b1.path.position;
      };
    }
  };

  //--------------------- main ---------------------

  window.params = {
    // stength of the interaction between balls
    // positive -> repulsion
    // negaitive -> attraction
    strength: 1,
    particleVelosity: 20,
    numBalls: 3,
    percentPositive: 0.1
  }


  var balls = [];
  for (var i = 0; i < params.numBalls; i++) {
    var radius = 30;
    var position = Point.random() * (view.size - [2*radius, 2*radius]) + [radius, radius];
    var vector = new Point({
        angle: 360 * Math.random(),
        length: Math.random() * 8
    });
    var charge = (function () {
      if ( Math.random() < params.percentPositive) {
        return 1;
      } else {
        return -1;
      }
    })();
    balls.push(new Ball(radius, position, vector, charge));
  }
  console.log(balls);

  var pairs = [];
  for (var i = 0; i <= balls.length; i++) {
    for (var j = i+1; j < balls.length; j++) {
      pairs.push(new Pair(balls[i], balls[j]))
    };
  };

  function onFrame() {
    for (var i = 0; i < pairs.length; i++) {
      pairs[i].iterate();
    };
    for (var i = 0, l = balls.length; i < l; i++) {
      balls[i].iterate();
    }
  }
</script>
</head>
<body>
  <div class="params">
    <label>Number of balls</label><br>
    <input type="range">
    <br>
    <label>Intaraction strength</label><br>
    <input type="range">
    <br>
    <label>Percent of positivly charged balls</label><br>
    <input type="range">
    <br>
    <label>Interaction particle velosity</label><br>
    <input type="range">
    <br>
    <!-- <label>Intaraction strength</label>
    <input type="range"> -->
  </div>
  <canvas id="cvs" resize hidpi="off" style="background:black"></canvas>
</body>
</html>
